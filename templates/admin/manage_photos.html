<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>Kelola Foto</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_style.css') }}" />
    <!-- Tambahkan ini di bagian <head> -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Modal overlay */
        .modal {
          display: none;
          position: fixed;
          z-index: 9999;
          left: 0; top: 0;
          width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.5);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #fff;
          padding: 20px 30px;
          border-radius: 10px;
          max-width: 400px;
          width: 90%;
          position: relative;
          text-align: center;
        }
        .close-btn {
          position: absolute;
          top: 10px; right: 15px;
          font-size: 28px;
          font-weight: bold;
          color: #333;
          cursor: pointer;
          user-select: none;
        }
        .close-btn:hover {
          color: #e91e63;
        }
        .btn-pink, .btn-delete {
          padding: 8px 16px;
          font-size: 0.9rem;
          font-weight: 700;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          transition: background-color 0.3s ease;
          color: #fff;
        }
        .btn-pink {
          background-color: #e91e63;
        }
        .btn-pink:hover {
          background-color: #c2185b;
        }
        .btn-delete {
          background-color: #f44336;
        }
        .btn-delete:hover {
          background-color: #b71c1c;
        }
        /* Table styling */
        table.photo-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          font-family: Arial, sans-serif;
        }
        table.photo-table th,
        table.photo-table td {
          border: 1px solid #ddd;
          padding: 12px 15px;
          text-align: center;
          vertical-align: middle;
        }
        table.photo-table th {
          background-color: #f5f5f5;
          color: #e91e63;
          font-weight: 700;
        }
        table.photo-table tbody tr:hover {
          background-color: #faf0f6;
        }
        table.photo-table img {
          max-width: 120px;
          max-height: 90px;
          border-radius: 6px;
          object-fit: cover;
        }




    </style>
</head>
<body>
    {% include 'admin/sidebar.html' %}


    <div class="admin-main-content">
        <h1>Hasil Foto</h1>

        {% if photos %}
        <table class="photo-table">
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Nama Foto</th>
                    <th>QR Code</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for photo in photos %}
                <tr id="photo-row-{{ photo.id }}">
                    <td>
                        <img src="{{ url_for('static', filename='photos/' + photo.filename) }}" alt="{{ photo.name }}" />
                    </td>
                    <td>{{ photo.name }}</td>
                    <td>
                      <button class="btn-pink btn-open-modal" data-photo-id="{{ photo.id }}">
                        QR Code Download
                      </button>
                    </td>
                    <td>
                      <button class="btn-delete" onclick="deletePhoto('{{ photo.id }}')">Hapus Foto</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>Tidak ada foto tersedia.</p>
        {% endif %}
    </div>

    <!-- Modal Popup -->
    <div id="qrModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Download QR Code</h2>
        <div id="qrCodeContainer">
          <p>Loading QR Code...</p>
        </div>
      </div>
    </div>

<script>
  function getQRCode(photoId) {
    const modal = document.getElementById('qrModal');
    const qrCodeContainer = document.getElementById('qrCodeContainer');

    modal.style.display = 'flex';
    qrCodeContainer.innerHTML = '<p>Loading QR Code...</p>';

    fetch(`/admin/photos/${encodeURIComponent(photoId)}/qrcode`)
      .then(response => {
        if (!response.ok) throw new Error('Gagal memuat QR Code');
        return response.blob();
      })
      .then(blob => {
        const imgURL = URL.createObjectURL(blob);
        qrCodeContainer.innerHTML = `<img src="${imgURL}" alt="QR Code" style="max-width:100%;">`;
      })
      .catch(() => {
        qrCodeContainer.innerHTML = '<p>Gagal memuat QR Code.</p>';
      });
  }

 function deletePhoto(photoId) {
  Swal.fire({
    title: 'Yakin ingin menghapus?',
    text: "Foto akan dihapus secara permanen!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#e91e63',
    cancelButtonColor: '#aaa',
    confirmButtonText: 'Ya, hapus foto!',
    cancelButtonText: 'Batal'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/photos/${encodeURIComponent(photoId)}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'   // ⬅️ Tambahkan DI SINI
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Gagal menghapus foto');
        return response.json();
      })
      .then(data => {
        Swal.fire({
          title: 'Terhapus!',
          text: 'Foto berhasil dihapus.',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });

        const row = document.getElementById(`photo-row-${photoId}`);
        if (row) row.remove();
      })
      .catch(err => {
        Swal.fire({
          title: 'Oops!',
          text: 'Terjadi kesalahan saat menghapus foto.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        console.error(err);
      });
    }
  });
}



  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('qrModal');
    const closeBtn = modal.querySelector('.close-btn');
    const qrCodeContainer = document.getElementById('qrCodeContainer');

    document.querySelectorAll('.btn-open-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        const photoId = btn.getAttribute('data-photo-id');
        getQRCode(photoId);
      });
    });

    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
      qrCodeContainer.innerHTML = '';
    });

    window.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
        qrCodeContainer.innerHTML = '';
      }
    });
  });
</script>
</body>
</html>
